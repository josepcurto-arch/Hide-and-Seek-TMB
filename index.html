<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cards Shuffle</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
html, body {
    margin: 0;
    padding: 0;
    height: 100dvh;
    overflow: hidden;
    touch-action: manipulation;
}

/* ---------- Main layout ---------- */
body {
    display: flex;
    flex-direction: column;
    background: url("background.png") center / cover no-repeat;
    position: relative; /* for config button positioning */
}

/* ---------- Timer area ---------- */
#timerContainer {
    height: 48px;                 /* fixed height */
    background: white;
    color: black;
    text-align: center;
    padding: 6px 8px;
    font-size: 14px;
    box-sizing: border-box;
    white-space: pre-line;
    flex-shrink: 0;               /* never shrink */
}

/* ---------- Image / card area ---------- */
#imageContainer {
    flex: 1;                       /* takes remaining space */
    display: flex;
    justify-content: center;
    align-items: center;
    box-sizing: border-box;
    border: 2px solid black;       /* separation line */
    overflow: hidden;              /* image stays inside container */
    position: relative;            /* allow clicks on img */
    z-index: 1;
}

#imageContainer img {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: contain;           /* always fully visible */
    user-select: none;             /* prevent text selection on mobile */
    pointer-events: none;          /* allow click to pass through image */
}

/* ---------- Config button ---------- */
#configBtn {
    position: absolute;
    top: 8px;
    right: 8px;
    padding: 8px 12px;
    background: white;
    color: black;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    z-index: 10;
}

#configMenu {
    position: absolute;
    top: 46px;
    right: 8px;
    background: #222;
    color: white;
    border-radius: 8px;
    padding: 10px;
    display: none;
    z-index: 10;
}

#configMenu button {
    width: 100%;
    margin: 4px 0;
    padding: 6px;
}
</style>
</head>

<body>

<div id="timerContainer"></div>

<div id="imageContainer">
    <img id="card" src="logo.png" alt="Card">
</div>

<button id="configBtn">Config</button>

<div id="configMenu">
    <button onclick="restartAll()">Restart</button>
    <button onclick="copyLog()">Copy log</button>
    <button onclick="copyShuffled()">Copy shuffled</button>
    <button onclick="importShuffled()">Import shuffled</button>
    <hr>
    <button onclick="showStatic('horari.png')">Horari</button>
    <button onclick="showStatic('punts.png')">Punts</button>
</div>

<script>
/* ---------- Constants ---------- */
const TOTAL_CARDS = 28;
const LIMIT = Math.ceil(TOTAL_CARDS * 0.75);
const SHUFFLED_KEY = "shuffled_cards";
const LOG_KEY = "cards_shuffle_log";
const EVENTS = [
    { name: "Quedada", time: "09:30" },
    { name: "Inici del joc", time: "10:00" },
    { name: "Inici Parada Dinar", time: "14:00" },
    { name: "Final Parada Dinar", time: "15:00" },
    { name: "Final del joc", time: "19:00" }
];

/* ---------- Elements ---------- */
const img = document.getElementById("card");
const menu = document.getElementById("configMenu");
const timerDiv = document.getElementById("timerContainer");

/* ---------- Storage helpers ---------- */
function loadArray(key) { return JSON.parse(localStorage.getItem(key)) || []; }
function saveArray(key, arr) { localStorage.setItem(key, JSON.stringify(arr)); }

/* ---------- Shuffle logic ---------- */
function showRandomCard() {
    let shuffled = loadArray(SHUFFLED_KEY);
    if (shuffled.length >= LIMIT) shuffled = [];

    const available = [];
    for (let i = 1; i <= TOTAL_CARDS; i++) {
        if (!shuffled.includes(i)) available.push(i);
    }

    const card = available[Math.floor(Math.random() * available.length)];
    shuffled.push(card);

    img.src = `Cards/${card}.png`;
    saveArray(SHUFFLED_KEY, shuffled);
    logCard(card);
}

function logCard(card) {
    const log = loadArray(LOG_KEY);
    log.push({ card, time: new Date().toLocaleString() });
    saveArray(LOG_KEY, log);
}

/* ---------- Static images ---------- */
function showStatic(file) { img.src = file; }

/* ---------- Config actions ---------- */
function restartAll() {
    localStorage.removeItem(SHUFFLED_KEY);
    localStorage.removeItem(LOG_KEY);
    img.src = "logo.png";
    alert("Restarted");
}

async function copyLog() { await navigator.clipboard.writeText(JSON.stringify(loadArray(LOG_KEY), null, 2)); alert("Log copied"); }
async function copyShuffled() { await navigator.clipboard.writeText(JSON.stringify(loadArray(SHUFFLED_KEY))); alert("Shuffled copied"); }
async function importShuffled() {
    try {
        const data = JSON.parse(await navigator.clipboard.readText());
        if (!Array.isArray(data)) throw 0;
        saveArray(SHUFFLED_KEY, data);
        alert("Shuffled imported");
    } catch { alert("Invalid clipboard data"); }
}

/* ---------- Time utilities ---------- */
function todayAt(hhmm) {
    const [h, m] = hhmm.split(":").map(Number);
    const d = new Date();
    d.setHours(h, m, 0, 0);
    return d;
}

function formatDuration(ms) {
    const s = Math.max(0, Math.floor(ms / 1000));
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const sec = s % 60;
    return `${h}h ${m}m ${sec}s`;
}

/* ---------- Timer logic ---------- */
function updateTimer() {
    const now = new Date();
    const quedada = todayAt("09:30");
    const finalGame = todayAt("19:00");

    if (now > finalGame && now < new Date(quedada.getTime() - 2 * 3600 * 1000)) {
        timerDiv.textContent = "";
        return;
    }

    const times = EVENTS.map(e => ({ name: e.name, date: todayAt(e.time) }));
    let next = times.find(e => e.date > now);
    if (!next) next = { name: "Quedada", date: new Date(quedada.getTime() + 24*3600*1000) };

    timerDiv.textContent = `${next.name}: ${formatDuration(next.date - now)}`;
}

/* ---------- UI events ---------- */
document.getElementById("imageContainer").addEventListener("click", () => {
    showRandomCard();
    menu.style.display = "none";
});

document.getElementById("configBtn").onclick = e => {
    e.stopPropagation();
    menu.style.display = menu.style.display === "block" ? "none" : "block";
};

setInterval(updateTimer, 1000);
updateTimer();

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js')
    .then(() => console.log('Service Worker Registered'))
    .catch(err => console.log('SW Registration failed:', err));
}

</script>

</body>
</html>
